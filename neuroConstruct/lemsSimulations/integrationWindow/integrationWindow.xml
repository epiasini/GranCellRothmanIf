<Lems>
  <Target component="integrationWindow"/> 

  <Include file="NeuroMLCoreDimensions.xml"/>
  <Include file="Cells.xml"/>
  <Include file="Networks.xml"/>
  <Include file="Simulation.xml"/>

  <ComponentType name="SpikeRecorder"
		 extends="baseSynapse"
		 description="Records the arrival times of incoming spikes, and keeps the count of the total. Very crude implementation, but gets the job done.">
    <Dynamics>
      <StateVariable name="i" exposure="i" dimension="current"/>
      <StateVariable name="spikeCount" dimension="none"/>
      <OnEvent port="in">
	<StateAssignment variable="spikeCount" value="spikeCount + 1"/>
      </OnEvent>
      <OnStart>
	<StateAssignment variable="i" value="0"/>
	<StateAssignment variable="spikeCount" value="0"/>
      </OnStart>
    </Dynamics>
  </ComponentType>

  <ComponentType name="spikeGeneratorDelay"
		 extends="spikeGenerator"
		 description="Simple generator of spikes at a regular interval
			      set by _period, emitting the first spike at time
			      _delay + _period.">
    <Parameter name="delay"
	       dimension="time"
	       description="Delay from the start of the simulation."/>
    <Dynamics>
      <StateVariable name="tsince" dimension="time" exposure="tsince"/>
      <TimeDerivative variable="tsince" value="1"/>
      <OnStart>
        <StateAssignment variable="tsince" value="- delay + period"/>
      </OnStart>
      <OnCondition test="tsince .gt. period">
        <StateAssignment variable="tsince" value="0"/>
        <EventOut port="spike"/>
      </OnCondition>
    </Dynamics>
  </ComponentType>

  <Include file="../../cellMechanisms/RothmanMFToGrCAMPA/RothmanMFToGrCAMPA.nml"/>
  <Include file="../../cellMechanisms/RothmanMFToGrCNMDA/RothmanMFToGrCNMDA.nml"/>
  <Include file="../../cellMechanisms/IaF_GrC/IaF_GrC.nml"/>

  <SpikeRecorder id="spikeRecorder"/>
  <iafRefCell id="IaF_GrC_nospike" leakReversal="-79.67mV" leakConductance="1.498nS" thresh="1000V" reset="-63mV" C="3.22pF" refract="2ms">
    <notes>
      IaF GrC cell modified to prevent spiking, as this is probably
      desirable while studying the integration window.
    </notes>
  </iafRefCell>

  <Include file="inputRate.xml"/>

  <network id="integrationWindowNetwork">
    <population id="mossySpikerPop" component="mossySpiker" size="4"/>
    <population id="GrCPop" component="IaF_GrC" size="1"/>
    <population id="GrCSecondLayerPop" component="IaF_GrC" size="1"/>

    <!-- mossy to granule AMPA -->
    <synapticConnection from="mossySpikerPop[0]" to="GrCPop[0]"
			synapse="RothmanMFToGrCAMPA"
			destination="synapses"/>
    <synapticConnection from="mossySpikerPop[1]" to="GrCPop[0]"
			synapse="RothmanMFToGrCAMPA"
			destination="synapses"/>
    <synapticConnection from="mossySpikerPop[2]" to="GrCPop[0]"
			synapse="RothmanMFToGrCAMPA"
			destination="synapses"/>
    <synapticConnection from="mossySpikerPop[3]" to="GrCPop[0]"
			synapse="RothmanMFToGrCAMPA"
			destination="synapses"/>
    <!-- mossy to granule NMDA -->
    <synapticConnection from="mossySpikerPop[0]" to="GrCPop[0]"
			synapse="RothmanMFToGrCNMDA"
			destination="synapses"/>
    <synapticConnection from="mossySpikerPop[1]" to="GrCPop[0]"
			synapse="RothmanMFToGrCNMDA"
			destination="synapses"/>
    <synapticConnection from="mossySpikerPop[2]" to="GrCPop[0]"
			synapse="RothmanMFToGrCNMDA"
			destination="synapses"/>
    <synapticConnection from="mossySpikerPop[3]" to="GrCPop[0]"
			synapse="RothmanMFToGrCNMDA"
			destination="synapses"/>

    <!-- granule to spike recorder -->
    <synapticConnection from="GrCPop[0]" to="GrCSecondLayerPop[0]" synapse="spikeRecorder" destination="synapses"/>
  </network>

  <Simulation id="integrationWindow" length="50 s" step="0.05 ms" target="integrationWindowNetwork">
    <OutputFile id="of0" fileName="voltage.dat">
      <OutputColumn id="v" quantity="GrCPop[0]/v"/>
      <OutputColumn id="sc" quantity="GrCSecondLayerPop[0]/spikeRecorder/spikeCount"/>
    </OutputFile>
  </Simulation>

  <Simulation id="showcase" length="0.5 s" step="0.025 ms" target="integrationWindowNetwork">
    <Display id="GrCPop_v" title="GrCPop, VOLTAGE" timeScale="1ms" xmin="-10.0" xmax="520.0" ymin="-80.0" ymax="-35.0">
      <Line id="GrCPop_v" timeScale="1ms" quantity="GrCPop[0]/v" scale="1 mV" color="#000000"/>
    </Display>
    <Display id="conductances" title="Synaptic conductances" timeScale="1ms" xmin="-10.0" xmax="520.0" ymin="-0.1" ymax="1">
      <Line id="gAMPA" timeScale="1ms" quantity="GrCPop[0]/RothmanMFToGrCAMPA/g" scale="1 nS" color="#DF013A"/>
      <Line id="gNMDA" timeScale="1ms" quantity="GrCPop[0]/RothmanMFToGrCNMDA/g" scale="1 nS" color="#4000FF"/>
    </Display>
    <Display id="currents" title="Synaptic currents" timeScale="1ms" xmin="-10.0" xmax="520.0" ymin="-20" ymax="40">
      <Line id="iAMPA" timeScale="1ms" quantity="GrCPop[0]/RothmanMFToGrCAMPA/i" scale="1 pA" color="#DF013A"/>
      <Line id="iNMDA" timeScale="1ms" quantity="GrCPop[0]/RothmanMFToGrCNMDA/i" scale="1 pA" color="#4000FF"/>
    </Display>
    <Display id="blockFactor" title="Blockage factor" timeScale="1ms" xmin="-10.0" xmax="520.0" ymin="0.05" ymax="0.25">
      <Line id="blockFactor" timeScale="1ms" quantity="GrCPop[0]/RothmanMFToGrCNMDA/blockFactor" scale="1" color="#4000FF"/>
    </Display>
  </Simulation>

</Lems>
